import{_ as H,u as I,C as R,p as U,e,o as u,c,b as n,t as a,F as g,r as F,v as f,M as L,s as p,f as w,Q as A,n as C,D as k,a2 as m,z as j,B as q,H as Q}from"./CJzXP6Za.js";const W={key:0,class:"view-common"},X={class:"vc-title"},G={class:"vc-tag"},K={class:"vc-opts"},Y=["title","onClick"],Z={class:"opt-txt"},ee={class:"opt-result"},te={class:"vc-status"},se={key:0,class:"status-end"},oe={key:1,class:"status-end"},ae={class:"vc-act"},ne=["disabled"],ie={key:1,class:"view-pk"},le={class:"vc-title"},ue={class:"vc-opts"},ce=["title","onClick"],re={class:"opt-txt multiLineCut"},de={class:"opt-result"},pe=["title","onClick"],ve={class:"opt-txt multiLineCut"},_e={class:"opt-result"},he={class:"vc-status"},ge={key:0,class:"status-end"},fe={key:1,class:"status-end"},M=4,me={__name:"TopicVoteCard",props:{vote:{type:Object,default:null}},emits:["updated"],setup($,{emit:P}){const T=$,J=P,{t:i}=I(),O=R(),t=C(null),r=C([]),_=C(!1),x=C(!1);U(()=>T.vote,o=>{if(!o){t.value=null,r.value=[],_.value=!1;return}t.value=JSON.parse(JSON.stringify(o)),r.value=[...o.optionIds||[]],_.value=!1},{immediate:!0,deep:!0});const b=k(()=>t.value&&t.value.type===1&&Array.isArray(t.value.options)&&t.value.options.length===2),h=k(()=>t.value&&!t.value.expired&&!t.value.voted&&O.isLogin&&!x.value),B=k(()=>t.value?i("pages.topic.detail.vote.titleMeta",{optionCount:t.value.options.length,voteNum:t.value.voteNum}):""),E=k(()=>{if(!h.value)return!0;if(t.value.type===1)return r.value.length!==1;const o=Number(t.value.voteNum)||1;return r.value.length===0||r.value.length>o});function D(o){let d=0,s=0,l=!1;const v=o||0;return(t.value.options||[]).forEach(S=>{d+=S?.voteCount||0}),(v||d)&&(s=Number((v/d*100).toFixed(0)),s<0&&(s=0),s>100&&(s=100),s>=100&&(l=!0)),{percent:s,isFull:l}}function y(o,d){let s=0,l=0;const v=o||0;return(t.value.options||[]).forEach(S=>{s+=S?.voteCount||0}),v||s?(l=Number((v/s*100).toFixed(0)),d&&l<30&&(l=30),l<0&&(l=0),l>100&&(l=100)):l=d?50:0,t.value.voted||(l=50),l}function z(){_.value=!_.value}async function V(){if(!O.isLogin){m(i("pages.topic.detail.vote.loginToVote"));return}if(h.value){if(E.value){if(t.value.type===1)m(i("pages.topic.detail.vote.selectRequired"));else{const o=Number(t.value.voteNum)||1;r.value.length>o?m(i("pages.topic.detail.vote.maxSelect",{num:o})):m(i("pages.topic.detail.vote.selectAtLeastOne"))}return}x.value=!0;try{const o=await j("/api/vote/cast",{voteId:t.value.id,optionIds:r.value});t.value=o,r.value=[...o.optionIds||[]],J("updated",o),q(i("pages.topic.detail.vote.submitSuccess"))}catch(o){Q(o.message||o)}finally{x.value=!1}}}function N(o){if(!h.value||!o)return;if(b.value){r.value=[o],V();return}const d=r.value.indexOf(o);if(d===-1)if(t.value.type===1)r.value=[o];else{const s=Number(t.value.voteNum)||1;r.value.length<s?r.value.push(o):m(i("pages.topic.detail.vote.maxSelect",{num:s}))}else r.value.splice(d,1)}return(o,d)=>e(t)&&e(t).title?(u(),c("div",{key:0,class:f(["vote-view",{VOTED:e(t).voted,EXPIRED:e(t).expired}])},[e(b)?p("",!0):(u(),c("div",W,[n("h5",X,[n("span",G,a(e(i)("pages.topic.detail.vote.tag")),1),n("span",null,a(e(t).title),1),n("span",null,"("+a(e(B))+")",1)]),n("div",K,[n("ul",null,[(u(!0),c(g,null,F(e(t).options,(s,l)=>(u(),c("li",{key:s.id,class:f(["EASE",{none:l>M-1&&!e(_),disabled:!e(h),chked:e(r).includes(s.id),voted:s.voted,highLight:!s.voted&&e(t).expired}]),title:s.content,onClick:v=>N(s.id)},[n("span",{class:f(["opt-percent",{FULL:D(s.voteCount).isFull}]),style:L({width:`${D(s.voteCount).percent}%`})},null,6),n("span",Z,a(s.content),1),n("span",ee,a(s.voteCount),1)],10,Y))),128))]),e(t).options&&e(t).options.length>M?(u(),c("button",{key:0,type:"button",class:"vc-more",onClick:z},a(e(_)?e(i)("pages.topic.detail.vote.collapseOptions"):e(i)("pages.topic.detail.vote.expandOptions")),1)):p("",!0)]),n("div",te,[w(a(e(i)("pages.topic.detail.vote.participants",{count:e(t).voteCount||0}))+" ",1),e(t).expired?(u(),c("span",se,a(e(i)("pages.topic.detail.vote.expired")),1)):p("",!0),e(t).expired?p("",!0):(u(),c("span",oe,a(e(i)("pages.topic.detail.vote.expiredAt"))+": "+a(("useFormatDate"in o?o.useFormatDate:e(A))(e(t).expiredAt)),1))]),n("div",ae,[n("button",{type:"button",class:"btn-sbmt",disabled:e(E),onClick:V},a(e(t).voted?e(i)("pages.topic.detail.vote.voted"):e(t).expired?e(i)("pages.topic.detail.vote.voteEnded"):e(i)("pages.topic.detail.vote.submit")),9,ne)])])),e(b)?(u(),c("div",ie,[n("h5",le,[d[0]||(d[0]=n("span",{class:"vc-tag"},null,-1)),n("span",null,a(e(t).title),1)]),n("div",ue,[(u(!0),c(g,null,F(e(t).options,(s,l)=>(u(),c(g,{key:`l-${s.id}`},[l===0?(u(),c("div",{key:0,class:f("opt-item OPT"+l+(s.voted&&!e(t).expired?" highLight":"")+(e(h)?"":" disabled")),style:L({width:`${y(s.voteCount,!0)}%`}),title:s.content,onClick:v=>N(s.id)},[n("span",re,a(s.content),1),n("div",de,a(s.voteCount)+" ("+a(y(s.voteCount,!1))+"%) "+a(s.voted?"  "+e(i)("pages.topic.detail.vote.votedShort"):""),1)],14,ce)):p("",!0)],64))),128)),d[1]||(d[1]=n("i",{class:"ic-pk-b"},null,-1)),(u(!0),c(g,null,F(e(t).options,(s,l)=>(u(),c(g,{key:`r-${s.id}`},[l===1?(u(),c("div",{key:0,class:f("opt-item OPT"+l+(s.voted&&!e(t).expired?" highLight":"")+(e(h)?"":" disabled")),style:L({width:`${y(s.voteCount,!0)}%`}),title:s.content,onClick:v=>N(s.id)},[n("span",ve,a(s.content),1),n("div",_e,a(s.voted?e(i)("pages.topic.detail.vote.votedShort")+"  ":"")+" "+a(s.voteCount)+" ("+a(y(s.voteCount,!1))+"%) ",1)],14,pe)):p("",!0)],64))),128))]),n("div",he,[w(a(e(i)("pages.topic.detail.vote.participants",{count:e(t).voteCount||0}))+" ",1),e(t).expired?(u(),c("span",ge,a(e(i)("pages.topic.detail.vote.expired")),1)):p("",!0),e(t).expired?p("",!0):(u(),c("span",fe,a(e(i)("pages.topic.detail.vote.expiredAt"))+": "+a(("useFormatDate"in o?o.useFormatDate:e(A))(e(t).expiredAt)),1))])])):p("",!0)],2)):p("",!0)}},Ce=H(me,[["__scopeId","data-v-2f9822fd"]]);export{Ce as _};
